# ПЛАН РАЗРАБОТКИ СИСТЕМЫ УПРАВЛЕНИЯ РЕЛЕ

## 1. АРХИТЕКТУРА СИСТЕМЫ

```
┌─────────────────────────────────────────────────────┐
│                    КЛИЕНТЫ                          │
│  PWA (Android/iOS)    Web-интерфейс СуперАдмина     │
└──────────────┬──────────────────────┬───────────────┘
               │ HTTPS/WSS            │ HTTPS
┌──────────────▼──────────────────────▼───────────────┐
│              СЕРВЕР (Docker/Podman)                  │
│  ┌─────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │  Nginx/     │  │  Backend     │  │  MQTT      │  │
│  │  Caddy      │  │  (Node.js/   │  │  Broker    │  │
│  │  (reverse   │  │  FastAPI)    │  │  (Mosquitto│  │
│  │  proxy+TLS) │  │              │  │  /EMQX)    │  │
│  └─────────────┘  └──────┬───────┘  └─────┬──────┘  │
│                          │                │          │
│                   ┌──────▼───────┐        │          │
│                   │  PostgreSQL  │        │          │
│                   │  + Redis     │        │          │
│                   └──────────────┘        │          │
└───────────────────────────────────────────┼──────────┘
                                            │ MQTT
                              ┌─────────────▼──────────┐
                              │  ESP8266/ESP32 + реле   │
                              └────────────────────────┘
```

---

## 2. МОДЕЛЬ ДАННЫХ

### Сущности и роли

```
SuperAdmin (1 экземпляр, задается в конфиге)
    └── создает Administrators

Group (канал/реле)
    ├── один Administrator (может быть в нескольких Group)
    ├── несколько Users
    └── одно Device (ESP)

User
    ├── может быть Administrator в нескольких Group
    └── может быть User в нескольких Group

Device
    ├── привязан к одной или двум Group (1 реле = 1 группа)
    ├── deviceId (MAC-адрес)
    └── firmwareVersion

EventLog
    ├── AdminLog (видит SuperAdmin через Web)
    └── GroupLog (видит Administrator группы через PWA)
```

### Схема БД (PostgreSQL)

```sql
users            — id, login, password_hash, created_at, created_by
groups           — id, name, mqtt_topic, created_at, created_by
user_groups      — user_id, group_id, role (admin|user)
devices          — id, device_id(MAC), group_ids[], fw_version, last_seen
sessions         — id, user_id, device_fingerprint, token, created_at
event_log        — id, group_id, user_id, action, payload, ts
admin_log        — id, actor_id, action, target_id, target_type, ts
```

---

## 3. СЕРВЕРНАЯ ЧАСТЬ

### 3.1 Стек технологий

| Компонент | Технология |
|-----------|-----------|
| Backend | **Node.js + Fastify** или **Python + FastAPI** |
| БД | **PostgreSQL** |
| Кэш/сессии | **Redis** |
| MQTT брокер | **Mosquitto** (с auth-plugin) |
| Reverse proxy | **Caddy** (автоматический TLS) |
| Контейнеры | **Docker Compose** / **Podman Compose** |

### 3.2 Структура Docker Compose

```yaml
# docker-compose.yml
services:
  caddy:          # reverse proxy + TLS (443→backend, /mqtt→ws)
  backend:        # REST API + WebSocket
  postgres:       # основная БД
  redis:          # сессии, очереди
  mosquitto:      # MQTT брокер (1883 internal, 8883 TLS external)
```

### 3.3 REST API endpoints

```
AUTH
  POST /api/auth/login
  POST /api/auth/logout
  GET  /api/auth/me

SUPERADMIN (Web-интерфейс)
  POST /api/sa/admins              — создать администратора
  GET  /api/sa/admins
  GET  /api/sa/groups
  GET  /api/sa/logs                — журнал администрирования

ADMIN (PWA, вкладка Администрирование)
  POST /api/admin/users            — добавить пользователя в группу
  GET  /api/admin/groups/:id/users
  GET  /api/admin/groups/:id/logs  — журнал группы

USER (PWA, основная вкладка)
  GET  /api/user/groups            — мои группы (кнопки)
  POST /api/user/groups/:id/trigger — нажатие кнопки → MQTT publish

DEVICE
  POST /api/device/register        — регистрация устройства
  GET  /api/device/status/:groupId — занятость канала
```

### 3.4 MQTT топики

```
relay/{groupId}/trigger     ← сервер публикует команду
relay/{groupId}/status      → устройство публикует состояние
relay/{groupId}/heartbeat   → устройство публикует раз в N сек
sys/devices/{deviceId}/info → устройство публикует при подключении
sys/devices/{deviceId}/lock → retained: занятость канала
```

Команда триггера:
```json
{"action":"pulse","duration":500,"user_id":"uuid","ts":1234567890}
```

### 3.5 Логика триггера на сервере

```
POST /trigger
  → проверить права пользователя на группу
  → записать в event_log
  → MQTT publish relay/{groupId}/trigger
  → вернуть 200 OK
```

### 3.6 Идентификация пользователя и устройства

JWT-токен содержит: `user_id`, `device_fingerprint` (хэш от UA + WebAuthn device key или canvas fingerprint). При каждом запросе сверяется fingerprint. Поддержка **Web Authentication API (WebAuthn/Passkeys)** как опция для строгой привязки к устройству.

---

## 4. PWA-ПРИЛОЖЕНИЕ

### 4.1 Стек

```
Vue 3 + Vite  или  React + Vite
PWA Plugin (Workbox) — офлайн-режим, иконки, манифест
WebSocket — для получения статусов в реальном времени
```

### 4.2 Структура вкладок

```
┌─────────────────────────────┐
│  [●] Название приложения    │
├─────────────────────────────┤
│                             │
│   [Основная] [Администр.]   │  ← вторая вкладка только для Admin
│                             │
├─────────────────────────────┤
│     ОСНОВНАЯ ВКЛАДКА        │
│   (кнопки управления)       │
└─────────────────────────────┘
```

### 4.3 Макеты кнопок (1–8 кнопок)

См. [Макеты кнопок](buttons.md)


Кнопка: большая (min 80×80px), с анимацией нажатия, индикатором состояния (цвет), названием канала. При нажатии — тактильная отдача (`navigator.vibrate(50)`).

### 4.4 Вкладка Администрирование (для Admin)

```
┌─────────────────────────────┐
│ Группа: [выбор группы ▼]   │
├─────────────────────────────┤
│ Пользователи:               │
│  + Добавить пользователя    │
│  ┌─────────────────────┐   │
│  │ Иван И. [удалить]   │   │
│  │ Петр П. [удалить]   │   │
│  └─────────────────────┘   │
├─────────────────────────────┤
│ Журнал событий:             │
│  12:01 Иван → К1 trigger   │
│  11:58 Петр → К1 trigger   │
└─────────────────────────────┘
```

---

## 5. СКЕТЧ ESP8266/ESP32

### 5.1 Конечный автомат устройства

```
                    ┌─────────────┐
              ─────►│  BOOT CHECK │
                    └──────┬──────┘
                    3 сброса за 5с?
                   ДА│           │НЕТ
                    ▼           ▼
             ┌──────────┐  ┌──────────┐
             │ CAPTIVE  │  │ WIFI     │
             │ PORTAL   │  │ CONNECT  │
             └──────┬───┘  └────┬─────┘
              таймаут│     успех│   неудача
                    ▼          ▼         ▼
              попытка    ┌──────────┐  CAPTIVE
              рабочего   │  MQTT    │  PORTAL
              режима     │ CONNECT  │
                         └────┬─────┘
                         ┌────┴─────┐
                         │  РАБОТА  │◄── команды
                         └──────────┘    heartbeat
```

### 5.2 Библиотеки Arduino

```cpp
// WiFi + CaptivePortal
#include <ESP8266WiFi.h>          // или WiFi.h для ESP32
#include <DNSServer.h>
#include <ESP8266WebServer.h>
#include <WiFiManager.h>          // CaptivePortal UI

// MQTT
#include <PubSubClient.h>

// Хранение настроек
#include <LittleFS.h>             // settings.json

// OTA
#include <ArduinoOTA.h>
#include <ESP8266HTTPUpdateServer.h>

// Таймеры
#include <Ticker.h>
```

### 5.3 Конфигурация (settings.json в LittleFS)

```json
{
  "wifi1_ssid": "",  "wifi1_pass": "",
  "wifi2_ssid": "",  "wifi2_pass": "",
  "mqtt_host": "",   "mqtt_port": 1883,
  "mqtt_user": "",   "mqtt_pass": "",
  "group1_id": "",
  "group2_id": "",   // пусто если 1 реле
  "device_id": ""    // MAC-адрес, заполняется автоматически
}
```

### 5.4 Пины (жестко в скетче)

```cpp
// Для ESP8266
#define RELAY1_PIN  D1
#define RELAY2_PIN  D2   // если 2 реле
#define LED_PIN     D4   // встроенный LED (инвертированный)
#define RESET_PIN   D3   // кнопка сброса (к GND)

// Длительность импульса реле (мс)
#define PULSE_MS    500
```

#### 5.4.1 Доработка логики
См. [Новая логика реле/кнопок](relay.md)


### 5.5 Индикация LED

| Режим | Индикация |
|-------|-----------|
| Загрузка | 3 быстрых вспышки |
| CaptivePortal активен | Медленное мигание 1с |
| Подключение к WiFi | Частое мигание 0.2с |
| Подключение к MQTT | Мигание 0.5с |
| Работа (готов) | Редкое мигание 3с (heartbeat) |
| Выполнение команды | 2 быстрые вспышки |
| Ошибка/канал занят | Быстрое мигание 0.1с, 10 раз |
| OTA обновление | Плавное мигание ~0.7с |

### 5.6 Логика занятости канала (MQTT retained)

```
При подключении:
  1. Subscribe на sys/devices/lock/{groupId}
  2. Если получен retained msg с чужим deviceId → канал занят
     → перейти в CaptivePortal с сообщением "Канал X занят"
  3. Если свободен → publish retained:
     sys/devices/lock/{groupId} = {"device_id":"AA:BB:..","ts":...}
  4. При отключении (LWT) → publish "" на топик lock (освободить)

```

### 5.7 Принудительный вход в CaptivePortal

```cpp
// В setup() — счетчик сбросов в RTC memory
struct RTCData { uint32_t resetCount; uint32_t lastReset; };
RTCData rtcData;
ESP.rtcUserMemoryRead(0, (uint32_t*)&rtcData, sizeof(rtcData));

uint32_t now = millis();
if (now - rtcData.lastReset < 5000) {
    rtcData.resetCount++;
} else {
    rtcData.resetCount = 1;
}
rtcData.lastReset = now;
ESP.rtcUserMemoryWrite(0, (uint32_t*)&rtcData, sizeof(rtcData));

if (rtcData.resetCount >= 3) {
    rtcData.resetCount = 0;
    ESP.rtcUserMemoryWrite(...);
    startCaptivePortal();
}
```

### 5.8 CaptivePortal страница (HTML в LittleFS)

Разделы:
- **WiFi**: SSID1/Pass1, SSID2/Pass2
- **MQTT**: Host, Port, User, Pass  
- **Группы**: Group1 ID, Group2 ID (если 2 реле)
- **Кнопки**: Сохранить и перезагрузить | Сбросить все настройки | Обновить прошивку (OTA)

Таймаут портала: **5 минут**, сбрасывается при реальном взаимодействии пользователя (отслеживается через POST-запросы, исключая автоопросы статуса).

### 5.9 Логика WiFi подключения с нарастающим таймаутом

```cpp
const char* networks[] = {wifi1_ssid, wifi2_ssid};
const char* passwords[] = {wifi1_pass, wifi2_pass};
int timeouts[] = {5, 10, 15, 20, 30}; // секунды

for (int attempt = 0; attempt < 5; attempt++) {
    for (int net = 0; net < 2; net++) {
        WiFi.begin(networks[net], passwords[net]);
        if (waitConnect(timeouts[attempt] * 1000)) {
            return SUCCESS;
        }
    }
}
// После 10 попыток → CaptivePortal
```

---

## 6. ЭТАПЫ РАЗРАБОТКИ

### Фаза 1 — Инфраструктура (1–2 недели)
- [ ] Docker Compose: Caddy + Backend + PostgreSQL + Redis + Mosquitto
- [ ] Схема БД, миграции
- [ ] Базовая аутентификация (JWT)
- [ ] Настройка MQTT с авторизацией

### Фаза 2 — Backend API (2–3 недели)
- [ ] CRUD пользователей/групп (SuperAdmin)
- [ ] CRUD пользователей группы (Admin)
- [ ] Endpoint триггера → MQTT publish
- [ ] Журналы событий
- [ ] WebSocket для real-time статусов

### Фаза 3 — PWA (2–3 недели)
- [ ] Авторизация, fingerprinting устройства
- [ ] Основная вкладка: адаптивные макеты 1–8 кнопок
- [ ] Вкладка Администрирование
- [ ] PWA манифест, Service Worker, иконки
- [ ] Тестирование на Android/iOS

### Фаза 4 — Web-интерфейс SuperAdmin (1 неделя)
- [ ] Управление администраторами и группами
- [ ] Просмотр журналов

### Фаза 5 — Скетч ESP (2–3 недели)
- [ ] CaptivePortal с сохранением настроек
- [ ] Логика 3 сбросов
- [ ] WiFi подключение с fallback
- [ ] MQTT подключение, lock-механизм
- [ ] Обработка команд + импульс реле
- [ ] Индикация LED
- [ ] OTA обновление
- [ ] Таймаут портала

### Фаза 6 — Интеграция и тестирование (1–2 недели)
- [ ] End-to-end тест: кнопка PWA → сервер → MQTT → реле
- [ ] Тест занятости канала
- [ ] Тест потери WiFi/MQTT
- [ ] Нагрузочное тестирование
- [ ] Документация и деплой

---

## 7. БЕЗОПАСНОСТЬ

- TLS везде: HTTPS (Caddy auto cert), MQTT over TLS (порт 8883)
- MQTT: каждое устройство — отдельный user/pass, ACL по топикам
- JWT: короткое время жизни + refresh token в httpOnly cookie
- Rate limiting на endpoint триггера (Redis)
- Device fingerprint привязан к сессии
- Пароли: bcrypt, минимум 12 итераций

---

## 8. СТРУКТУРА РЕПОЗИТОРИЯ

```
/
├── docker-compose.yml
├── caddy/Caddyfile
├── mosquitto/
│   ├── mosquitto.conf
│   └── acl.conf
├── backend/
│   ├── src/
│   │   ├── routes/
│   │   ├── services/
│   │   ├── mqtt/
│   │   └── db/migrations/
│   └── Dockerfile
├── pwa/
│   ├── src/
│   │   ├── views/MainTab.vue
│   │   ├── views/AdminTab.vue
│   │   └── components/RelayButton.vue
│   └── Dockerfile
├── admin-web/          # SuperAdmin интерфейс
└── esp/
    ├── relay_controller/
    │   ├── relay_controller.ino
    │   ├── config.h
    │   ├── wifi_manager.h
    │   ├── mqtt_handler.h
    │   ├── led_indicator.h
    │   └── captive_portal.h
    └── data/           # LittleFS: HTML портала
        └── index.html
```


## 9. Планы расширения возможностей

См. [Расширение возможностей](extention.md)