# ──────────────────────────────────────────────────────────────────
# /etc/nginx/conf.d/janitor.conf
#
# Добавляет маршрут /janitor/ к существующему nginx.
# Подключить командой:
#   docker exec nginx nginx -s reload
#
# ВАЖНО: этот файл монтируется через volume в nginx контейнер.
# Добавьте в smilart.yaml в секцию nginx → volumes:
#   - "/opt/janitor/nginx/janitor.conf:/etc/nginx/conf.d/janitor.conf:ro"
# ──────────────────────────────────────────────────────────────────

server {
    listen 3030;
    server_name smilart.ru www.smilart.ru;

    # ── Health check (без авторизации) ───────────────────────────
    location = /janitor/health {
        proxy_pass         http://janitor-backend:3000/janitor/health;
        proxy_set_header   Host $host;
        access_log         off;
    }

    # ── REST API ──────────────────────────────────────────────────
    location /janitor/api/ {
        proxy_pass         http://janitor-backend:3000/janitor/api/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;
    }

    # ── WebSocket (real-time статусы реле) ────────────────────────
    location /janitor/ws {
        proxy_pass         http://janitor-backend:3000/janitor/ws;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;   # держим WS соединение
        proxy_send_timeout 86400s;
    }

    # ── PWA статика (frontend) ────────────────────────────────────
    location /janitor/ {
        proxy_pass         http://janitor-backend:3000/janitor/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;

        # PWA: service worker требует правильных заголовков
        add_header         Cache-Control "no-cache" always;
        add_header         Service-Worker-Allowed "/" always;
    }
}
